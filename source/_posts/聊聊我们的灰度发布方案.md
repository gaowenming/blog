---
title: 聊聊我们的灰度发布方案
date: 2018-01-24 22:17:14
tags: 灰度发布
categories: 分布式
---

> 在项目快速迭代的过程中，系统上线是我们日常非常频繁的工作，稳定可靠的部署方案就非常重要了。
<!-- more -->

部署方案
---
当前主流的部署方案主要有如下几种：

 - 蓝绿部署

蓝绿部署是不停老版本，部署新版本然后进行测试，确认OK，将流量切到新版本，然后老版本同时也升级到新版本。

 - 滚动部署

滚动发布：一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本。

 - 灰度部署

灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。ABtest就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。

如何选择适合自己的方案
---
上面几种方案，各有利弊，简单分析下
蓝绿部署，占用资源比较多，因为需要2套完整的部署环境，但是有点也明显，2套环境完全隔离，验证完直接切换就行
滚动部署，直接更新线上的节点验证，风险比较大，而且验证也不方便
灰度部署，这种方式应该算是比较好的，我们可以把某个节点专门设为灰度节点，所有的上线前的验证都打到灰度节点，验证完之后，就可以全量更新。

我们的灰度方案
---
经过一段时间的探索，我们也慢慢的完善了我们自己的灰度发布方案，总体的设计思路如下
1、数据存储，灰度节点和线上节点共用一套，包括数据库MySql，Redis、Elasticsearch
2、中间件单独一套，中间件包括ZK，MQ

> 为什么要这么做呢？
 
 - 分析起来也很容易理解，我们要想在灰度环境验证功能，首先要保证数据和线上是一致的，这样才能保证验证的场景一致，我们的数据主要包含数据库，缓存，索引数据。
 - 中间件也很好理解，我们的服务现在主要是2种，提供API接口的Http服务，提供内部调用的Dubbo服务，流量从Nginx到达API服务后，怎么才能调度到我们的灰度节点呢？那就是通过ZK，Dubbo服务注册到ZK中，ZK和线上的服务区分开，这样就完成了灰度节点中的服务调用问题
 - MQ区分的原因是因为MQ是监听机制，只要监听了同一个服务，都可以消费到该服务的消息，所以把MQ单独出来，也就解决了线上数据被灰度节点消费的问题。
 
> 我们的总体灰度部署方案如下：
![](/images/publish.png "")
 


