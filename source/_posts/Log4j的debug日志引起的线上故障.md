---
title: Log4j的debug日志引起的线上故障
date: 2017-12-22 21:41:19
tags: [Log4j]
categories: 故障分析
---
> 前天下午，运维突然在微信群里说系统流量下跌了，报警邮件也马上来了，都是api接口的time out，查看各种监控工具，zabbix，oneapm，es集群，除了发现流量有下跌，没有别的异常情况。
<!-- more -->

错误现象
---

 1. 入口流量没有明显增加
    查看了流量监控，入口流量并没有出现爆发式的增长，很平稳，毕竟我们的流量高峰是在上午，下午3点很难出现高峰
 2. 内存、CPU没有明显波动
    查看系统的运行状态，内存、CPU都没有出现大的波动，说明并没有出现大的计算任务，如果有计算型的任务，会消耗大量的内存和CPU资源
 3. 线程数上升迅猛
    看监控，配置的Tomcat的线程池满了，直接导致了系统的请求超时。
[图片]

异常原因分析
---
>既然已经确认是由于线程池的堆积，造成系统的调用超时，那么为什么会突然之间线程池暴涨呢？
原因竟然是由于一个同事开启了线上的debug日志跟踪一个问题，持续时间大概20分钟，那么问题来了，log4j开启debug日志，为什么会导致线程池暴涨，造成系统崩溃呢？


>由于log4j同步打日志，当debug日志过多时，频繁的写磁盘文件，api请求的耗时就会增加，那么该api占用的线程的时间就会变长，当占用时间过长，导致线程池不够时，就会出现等待的情况，持续时间一长，等待的线程越来越多，那么就会出现time out了

如何解决
---

 1. 规范日志的打印
    日志打印不是越多越好，其实只要关键位置的日志往往就可以，比如方法的入口和出口，逻辑的分叉，try/catch的异常日志
 2. 异常信息的拼装
    往往debug的时候，打印日志都是很详细的，比如某个对象的完整信息，Http的完整响应等，这些信息都是比较大的，这时候如果用log.debug(Json.toJSONString(user));也许你觉得这么写也没有什么问题啊，其实不然，虽然如果你设置info级别，这个debug日志是不会打印，但是它会执行Json的转换，这其实也是损耗性能的，系统的性能往往就是细节地方不注意，累计多了，就会出现瓶颈。
这时，可以使用级别判断来解决这个问题
>if(log.isDebugEnable) {
　　LOG.debug("params = {}", JSON.toJSONString(user));
　}
 3. 可以采用logback、log4j2来替换log4j。
    log4j2已经发行了稳定版本，logback是基于slf4j的门面实现，性能都比log4j高不少

